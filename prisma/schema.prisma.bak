generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String       @id @default(cuid())
  email          String       @unique
  name           String?
  password       String
  role           UserRole

  nationalId     String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  coursesCreated Course[]     @relation("CourseCreator")
  enrollments    Enrollment[]
  companies      Company[]
  contracts      Contract[]
  managedContracts Contract[] @relation("ContractAdmin")

  @@index([email])
}

model Company {
  id                 String              @id @default(cuid())
  name               String
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  courses            Course[]
  enrollments        Enrollment[]
  users              User[]
  contracts          Contract[]
  preRegisteredUsers PreRegisteredUser[]
}

model Contract {
  id          String         @id @default(cuid())
  companyId   String
  company     Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  adminId     String?
  admin       User?          @relation("ContractAdmin", fields: [adminId], references: [id])
  adminEmail  String?
  startDate   DateTime
  endDate     DateTime
  status      ContractStatus @default(PENDING)
  documentUrl String?
  maxUsers    Int?           @default(0) // 0 means unlimited
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  courses     Course[]
  users       User[]
  preRegisteredUsers PreRegisteredUser[]

  @@index([companyId])
}

model PreRegisteredUser {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String?
  nationalId   String?
  companyId    String
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  isRegistered Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  contracts    Contract[]

  @@index([companyId])
}

model Course {
  id              String           @id @default(cuid())
  title           String
  description     String?
  status          CourseStatus     @default(DRAFT)
  companyId       String?
  creatorId       String
  expertId        String?
  coverImage      String?
  approvedAt      DateTime?
  publishedAt     DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  company         Company?         @relation(fields: [companyId], references: [id])
  creator         User             @relation("CourseCreator", fields: [creatorId], references: [id])
  expert          Expert?          @relation(fields: [expertId], references: [id])
  enrollments     Enrollment[]
  finalEvaluation FinalEvaluation?
  contracts       Contract[]
  modules         Module[]
}

model Expert {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  courses   Course[]
}

model Module {
  id          String           @id @default(cuid())
  courseId    String
  title       String
  description String?
  order       Int
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  lessons     Lesson[]
  course      Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  progress    ModuleProgress[]

  @@index([courseId])
}

model Lesson {
  id         String           @id @default(cuid())
  moduleId   String
  title      String
  content    String
  order      Int
  videoUrl   String?
  audioUrl   String?
  images     Json?            @default("[]")
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  flashcards Flashcard[]
  module     Module           @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  progress   LessonProgress[]
  quizzes    Quiz[]

  @@index([moduleId])
}

model Quiz {
  id          String        @id @default(cuid())
  lessonId    String
  question    String
  options     Json
  explanation String?
  order       Int
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  lesson      Lesson        @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  attempts    QuizAttempt[]

  @@index([lessonId])
}

model Flashcard {
  id        String   @id @default(cuid())
  lessonId  String
  front     String
  back      String
  order     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId])
}

model FinalEvaluation {
  id           String              @id @default(cuid())
  courseId     String              @unique
  questions    Json
  passingScore Int                 @default(70)
  timeLimit    Int?                // In minutes
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  attempts     EvaluationAttempt[]
  course       Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)
}

model Enrollment {
  id                 String              @id @default(cuid())
  userId             String
  courseId           String
  companyId          String
  status             EnrollmentStatus    @default(NOT_STARTED)
  startedAt          DateTime?
  completedAt        DateTime?
  totalTimeSpent     Int                 @default(0)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  company            Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  course             Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  evaluationAttempts EvaluationAttempt[]
  lessonProgress     LessonProgress[]
  moduleProgress     ModuleProgress[]
  quizAttempts       QuizAttempt[]

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@index([companyId])
}

model ModuleProgress {
  id           String     @id @default(cuid())
  enrollmentId String
  moduleId     String
  completed    Boolean    @default(false)
  timeSpent    Int        @default(0)
  completedAt  DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  module       Module     @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, moduleId])
  @@index([enrollmentId])
}

model LessonProgress {
  id           String     @id @default(cuid())
  enrollmentId String
  lessonId     String
  completed    Boolean    @default(false)
  timeSpent    Int        @default(0)
  completedAt  DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lesson       Lesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, lessonId])
  @@index([enrollmentId])
}

model QuizAttempt {
  id           String     @id @default(cuid())
  enrollmentId String
  quizId       String
  score        Int
  answers      Json
  completedAt  DateTime   @default(now())
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  quiz         Quiz       @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([enrollmentId])
  @@index([quizId])
}

model EvaluationAttempt {
  id           String          @id @default(cuid())
  enrollmentId String
  evaluationId String
  score        Int
  passed       Boolean
  answers      Json
  aiScore      Int?
  aiReasoning  String?
  completedAt  DateTime        @default(now())
  enrollment   Enrollment      @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  evaluation   FinalEvaluation @relation(fields: [evaluationId], references: [id], onDelete: Cascade)

  @@index([enrollmentId])
  @@index([evaluationId])
}

enum UserRole {
  ADMIN
  CLIENT
  EMPLOYEE
  CONTRACT_ADMIN
}

enum CourseStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  PUBLISHED
}

enum EnrollmentStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

enum ContractStatus {
  ACTIVE
  EXPIRED
  PENDING
}

enum LeadStatus {
  SIN_CONTACTAR
  PRIMER_CONTACTO
  VEINTICUATRO_HORAS_ANTES
  MANANA_MISMO_DIA
  MEDIA_HORA_ANTES
  NO_APARECIO
  CERRADO
  INICIAMOS_TRABAJO
}

model Lead {
  id           String     @id @default(cuid())
  nombre       String
  celular      String
  correo       String     @unique
  empresa      String
  cargo        String
  numEmpleados String
  status       LeadStatus @default(SIN_CONTACTAR)
  notes        String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([correo])
  @@index([status])
}

